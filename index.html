<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Leo Infotech - Blazor App</title>
    <base href="/" />
    <link rel="preload" id="webassembly" />
    <link rel="stylesheet" href="lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/app.css" />
    <link rel="icon" type="image/png" href="favicon.png" />
    <link href="BlazorApp2.styles.css" rel="stylesheet" />
    <script type="importmap"></script>
    
    <!-- Tunnel Status Styles -->
    <style>
        .tunnel-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: white;
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 9999;
            border-left: 4px solid #007bff;
            max-width: 300px;
            font-size: 12px;
        }
        .online { border-left-color: #28a745; }
        .offline { border-left-color: #dc3545; }
        .tunnel-url {
            word-break: break-all;
            font-family: monospace;
            background: #f8f9fa;
            padding: 5px;
            border-radius: 3px;
            margin-top: 5px;
        }
    </style>
</head>

<body>
    <!-- Tunnel Status Panel -->
    <div id="tunnelStatus" class="tunnel-status">
        <strong>Tunnel Status:</strong> <span id="tunnelStatusText">Loading...</span><br>
        <div id="tunnelUrlDisplay" class="tunnel-url"></div>
    </div>

    <div id="app">
        <!-- Hidden iframe to load tunnel URL -->
        <iframe 
            id="tunnelLoader"
            src="https://raw.githubusercontent.com/leoinfotechchinnamanur/leoinfotech/main/TUNNEL_URL.txt" 
            style="display:none;"
        ></iframe>
        
        <!-- Blazor Loading -->
        <svg class="loading-progress">
            <circle r="40%" cx="50%" cy="50%" />
            <circle r="40%" cx="50%" cy="50%" />
        </svg>
        <div class="loading-progress-text"></div>
    </div>

    <div id="blazor-error-ui">
        An unhandled error has occurred.
        <a href="." class="reload">Reload</a>
        <span class="dismiss">ðŸ—™</span>
    </div>
    
    <!-- Blazor Framework Script -->
    <script src="_framework/blazor.webassembly.js"></script>
    
    <!-- Tunnel Integration Script -->
    <script>
        // Function to load tunnel URL from GitHub
        function loadTunnelFromGitHub() {
            const iframe = document.getElementById('tunnelLoader');
            const statusText = document.getElementById('tunnelStatusText');
            const urlDisplay = document.getElementById('tunnelUrlDisplay');
            const statusPanel = document.getElementById('tunnelStatus');
            
            try {
                // Get content from iframe
                const tunnelUrl = iframe.contentDocument.body.textContent.trim();
                
                if (tunnelUrl && tunnelUrl.startsWith('http')) {
                    // Update status
                    statusText.textContent = 'ONLINE';
                    statusPanel.classList.add('online');
                    statusPanel.classList.remove('offline');
                    
                    // Display URL
                    urlDisplay.innerHTML = `<a href="${tunnelUrl}" target="_blank">${tunnelUrl}</a>`;
                    
                    // Store in localStorage for later use
                    localStorage.setItem('lastTunnelUrl', tunnelUrl);
                    localStorage.setItem('lastTunnelUpdate', new Date().toISOString());
                    
                    // Store in window object for Blazor to access
                    window.currentTunnelUrl = tunnelUrl;
                    
                    console.log('Tunnel URL loaded:', tunnelUrl);
                    
                    // Optional: Redirect to tunnel after Blazor loads
                    // setTimeout(() => {
                    //     window.location.href = tunnelUrl + '/Home/Privacy';
                    // }, 3000);
                    
                    return tunnelUrl;
                } else {
                    throw new Error('Invalid tunnel URL');
                }
            } catch (error) {
                console.error('Failed to load tunnel URL:', error);
                
                // Try to use cached URL
                const cachedUrl = localStorage.getItem('lastTunnelUrl');
                if (cachedUrl) {
                    statusText.textContent = 'USING CACHED URL';
                    statusPanel.classList.add('offline');
                    urlDisplay.textContent = cachedUrl + ' (cached)';
                    window.currentTunnelUrl = cachedUrl;
                    return cachedUrl;
                }
                
                // No URL available
                statusText.textContent = 'OFFLINE';
                statusPanel.classList.add('offline');
                urlDisplay.textContent = 'No tunnel URL available';
                return null;
            }
        }
        
        // Function to test tunnel connection
        async function testTunnelConnection(tunnelUrl) {
            try {
                const response = await fetch(tunnelUrl + '/Home/Privacy', {
                    method: 'HEAD',
                    mode: 'no-cors',
                    cache: 'no-store'
                });
                return true;
            } catch (error) {
                return false;
            }
        }
        
        // Initialize when iframe loads
        document.getElementById('tunnelLoader').onload = function() {
            const tunnelUrl = loadTunnelFromGitHub();
            
            if (tunnelUrl) {
                // Test connection
                testTunnelConnection(tunnelUrl).then(isOnline => {
                    const statusPanel = document.getElementById('tunnelStatus');
                    const statusText = document.getElementById('tunnelStatusText');
                    
                    if (isOnline) {
                        statusText.textContent = 'ONLINE âœ“';
                        statusPanel.classList.add('online');
                        statusPanel.classList.remove('offline');
                    } else {
                        statusText.textContent = 'URL LOADED BUT OFFLINE';
                        statusPanel.classList.add('offline');
                    }
                });
            }
        };
        
        // Fallback: If iframe fails, try direct fetch after 3 seconds
        setTimeout(() => {
            if (!window.currentTunnelUrl) {
                fetch('https://raw.githubusercontent.com/leoinfotechchinnamanur/leoinfotech/main/TUNNEL_URL.txt')
                    .then(response => response.text())
                    .then(text => {
                        const tunnelUrl = text.trim();
                        if (tunnelUrl.startsWith('http')) {
                            window.currentTunnelUrl = tunnelUrl;
                            loadTunnelFromGitHub(); // Update UI
                        }
                    })
                    .catch(console.error);
            }
        }, 3000);
        
        // Make function available globally for Blazor interop
        window.getTunnelUrl = function() {
            return window.currentTunnelUrl || localStorage.getItem('lastTunnelUrl');
        };
        
        // Auto-refresh tunnel URL every 5 minutes
        setInterval(() => {
            if (window.currentTunnelUrl) {
                fetch('https://raw.githubusercontent.com/leoinfotechchinnamanur/leoinfotech/main/TUNNEL_URL.txt')
                    .then(response => response.text())
                    .then(text => {
                        const newUrl = text.trim();
                        if (newUrl.startsWith('http') && newUrl !== window.currentTunnelUrl) {
                            console.log('Tunnel URL updated to:', newUrl);
                            window.currentTunnelUrl = newUrl;
                            localStorage.setItem('lastTunnelUrl', newUrl);
                            localStorage.setItem('lastTunnelUpdate', new Date().toISOString());
                            
                            // Update UI
                            document.getElementById('tunnelUrlDisplay').innerHTML = 
                                `<a href="${newUrl}" target="_blank">${newUrl}</a>`;
                        }
                    })
                    .catch(console.error);
            }
        }, 5 * 60 * 1000); // 5 minutes
    </script>
    
    <!-- Blazor .NET interop (if you want to use tunnel URL in Blazor components) -->
    <script>
        // Initialize Blazor interop
        window.initializeBlazorInterop = function(dotNetHelper) {
            window.dotNetHelper = dotNetHelper;
            
            // Provide tunnel URL to Blazor
            dotNetHelper.invokeMethodAsync('SetTunnelUrl', window.currentTunnelUrl)
                .catch(console.error);
                
            // Listen for tunnel URL requests from Blazor
            window.addEventListener('getTunnelUrl', function() {
                dotNetHelper.invokeMethodAsync('ReceiveTunnelUrl', window.currentTunnelUrl)
                    .catch(console.error);
            });
        };
    </script>
</body>

</html>
